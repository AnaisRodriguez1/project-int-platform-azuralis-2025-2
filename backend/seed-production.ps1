# ============================================
# SCRIPT PARA POBLAR BASE DE DATOS DE PRODUCCI√ìN (AZURE SQL)
# ============================================

Write-Host "üöÄ POBLANDO BASE DE DATOS DE PRODUCCI√ìN (Azure SQL)" -ForegroundColor Cyan
Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Cyan
Write-Host ""

# Verificar que el backend est√© corriendo en modo producci√≥n
Write-Host "‚ö†Ô∏è  IMPORTANTE: Aseg√∫rate de que el backend est√© corriendo con:" -ForegroundColor Yellow
Write-Host "   cd backend" -ForegroundColor White
Write-Host "   npm run prod" -ForegroundColor White
Write-Host ""

$continue = Read-Host "¬øEl backend est√° corriendo en modo producci√≥n? (s/n)"
if ($continue -ne "s" -and $continue -ne "S") {
    Write-Host "‚ùå Abortando. Por favor inicia el backend primero." -ForegroundColor Red
    exit
}

Write-Host ""

$API_URL = "http://localhost:3000"

# ============================================
# FUNCI√ìN AUXILIAR PARA HACER REQUESTS
# ============================================
function Invoke-ApiRequest {
    param(
        [string]$Method,
        [string]$Endpoint,
        [object]$Body,
        [string]$Token
    )
    
    $headers = @{
        "Content-Type" = "application/json"
    }
    
    if ($Token) {
        $headers["Authorization"] = "Bearer $token"
    }
    
    try {
        if ($Body) {
            $jsonBody = $Body | ConvertTo-Json -Depth 10
            Write-Host "   Request: $Method $Endpoint" -ForegroundColor Gray
            $response = Invoke-RestMethod -Uri "$API_URL$Endpoint" -Method $Method -Headers $headers -Body $jsonBody -ErrorAction Stop
        } else {
            Write-Host "   Request: $Method $Endpoint" -ForegroundColor Gray
            $response = Invoke-RestMethod -Uri "$API_URL$Endpoint" -Method $Method -Headers $headers -ErrorAction Stop
        }
        return $response
    } catch {
        Write-Host "‚ùå Error en $Method $Endpoint" -ForegroundColor Red
        Write-Host "   Detalle: $($_.Exception.Message)" -ForegroundColor Red
        if ($_.ErrorDetails.Message) {
            Write-Host "   Respuesta: $($_.ErrorDetails.Message)" -ForegroundColor Red
        }
        return $null
    }
}

# ============================================
# 1. REGISTRAR M√âDICOS
# ============================================
Write-Host "üë®‚Äç‚öïÔ∏è  Registrando m√©dicos..." -ForegroundColor Yellow
Write-Host ""

$doctor1 = @{
    name = "Dr. Carlos Mendoza"
    email = "carlos.mendoza@hospital.cl"
    password = "Doctor123!"
    rut = "12.345.678-9"
    role = "doctor"
}

$doctor2 = @{
    name = "Dra. Mar√≠a Gonz√°lez"
    email = "maria.gonzalez@hospital.cl"
    password = "Doctor123!"
    rut = "23.456.789-0"
    role = "doctor"
}

$doc1Response = Invoke-ApiRequest -Method "POST" -Endpoint "/auth/register" -Body $doctor1
if ($doc1Response) {
    Write-Host "‚úÖ M√©dico creado: Dr. Carlos Mendoza (ID: $($doc1Response.id))" -ForegroundColor Green
    $doctor1Id = $doc1Response.id
} else {
    Write-Host "‚ö†Ô∏è  Dr. Carlos Mendoza ya existe o hubo un error" -ForegroundColor Yellow
    # Intentar obtener el ID haciendo login
    $loginDoc1 = Invoke-ApiRequest -Method "POST" -Endpoint "/auth/login" -Body @{
        email = $doctor1.email
        password = $doctor1.password
    }
    if ($loginDoc1) {
        Write-Host "   ‚ÑπÔ∏è  Usuario ya existe, obteniendo datos..." -ForegroundColor Cyan
    }
}

$doc2Response = Invoke-ApiRequest -Method "POST" -Endpoint "/auth/register" -Body $doctor2
if ($doc2Response) {
    Write-Host "‚úÖ M√©dico creado: Dra. Mar√≠a Gonz√°lez (ID: $($doc2Response.id))" -ForegroundColor Green
    $doctor2Id = $doc2Response.id
} else {
    Write-Host "‚ö†Ô∏è  Dra. Mar√≠a Gonz√°lez ya existe o hubo un error" -ForegroundColor Yellow
}

Write-Host ""

# ============================================
# 2. REGISTRAR ENFERMERAS
# ============================================
Write-Host "üë©‚Äç‚öïÔ∏è  Registrando enfermeras..." -ForegroundColor Yellow
Write-Host ""

$nurse1 = @{
    name = "Enfermera Ana P√©rez"
    email = "ana.perez@hospital.cl"
    password = "Nurse123!"
    rut = "34.567.890-1"
    role = "nurse"
}

$nurse2 = @{
    name = "Enfermero Jos√© Silva"
    email = "jose.silva@hospital.cl"
    password = "Nurse123!"
    rut = "45.678.901-2"
    role = "nurse"
}

$nurse1Response = Invoke-ApiRequest -Method "POST" -Endpoint "/auth/register" -Body $nurse1
if ($nurse1Response) {
    Write-Host "‚úÖ Enfermera creada: Ana P√©rez (ID: $($nurse1Response.id))" -ForegroundColor Green
    $nurse1Id = $nurse1Response.id
}

$nurse2Response = Invoke-ApiRequest -Method "POST" -Endpoint "/auth/register" -Body $nurse2
if ($nurse2Response) {
    Write-Host "‚úÖ Enfermero creado: Jos√© Silva (ID: $($nurse2Response.id))" -ForegroundColor Green
    $nurse2Id = $nurse2Response.id
}

Write-Host ""

# ============================================
# 3. LOGIN COMO M√âDICO PARA CREAR PACIENTES
# ============================================
Write-Host "üîê Haciendo login como Dr. Carlos Mendoza..." -ForegroundColor Yellow
Write-Host ""

$loginResponse = Invoke-ApiRequest -Method "POST" -Endpoint "/auth/login" -Body @{
    email = "carlos.mendoza@hospital.cl"
    password = "Doctor123!"
}

if (-not $loginResponse) {
    Write-Host "‚ùå No se pudo hacer login. Abortando..." -ForegroundColor Red
    exit 1
}

$token = $loginResponse.access_token
Write-Host "‚úÖ Login exitoso! Token obtenido" -ForegroundColor Green
Write-Host ""

# Obtener datos del m√©dico
$meResponse = Invoke-ApiRequest -Method "GET" -Endpoint "/auth/me" -Token $token
if ($meResponse) {
    Write-Host "‚úÖ Datos del m√©dico obtenidos:" -ForegroundColor Green
    Write-Host "   Nombre: $($meResponse.name)" -ForegroundColor Gray
    Write-Host "   Email: $($meResponse.email)" -ForegroundColor Gray
    Write-Host "   Role: $($meResponse.role)" -ForegroundColor Gray
    $doctor1Id = $meResponse.id
}

Write-Host ""

# ============================================
# 4. CREAR PACIENTES
# ============================================
Write-Host "üë§ Creando pacientes..." -ForegroundColor Yellow
Write-Host ""

$patient1 = @{
    name = "Sof√≠a Ram√≠rez"
    age = 45
    rut = "56.789.012-3"
    photo = "https://i.pravatar.cc/150?img=1"
    diagnosis = "C√°ncer de Mama"
    stage = "Etapa II"
    cancerType = "breast"
    allergies = '["Penicilina","Ibuprofeno"]'
    currentMedications = '["Tamoxifeno 20mg - cada 12 horas","Paracetamol 500mg - seg√∫n necesidad"]'
    treatmentSummary = "Paciente diagnosticada con c√°ncer de mama en estadio II. Se realiz√≥ mastectom√≠a parcial seguida de quimioterapia adyuvante. Actualmente en terapia hormonal con Tamoxifeno. Pron√≥stico favorable."
}

$patient2 = @{
    name = "Pedro Flores"
    age = 62
    rut = "67.890.123-4"
    photo = "https://i.pravatar.cc/150?img=12"
    diagnosis = "Linfoma de Hodgkin"
    stage = "Etapa III"
    cancerType = "other"
    allergies = '["Aspirina"]'
    currentMedications = '["Doxorrubicina 50mg IV - cada 21 d√≠as","Prednisona 40mg - diario","Ondansetr√≥n 8mg - seg√∫n necesidad"]'
    treatmentSummary = "Paciente con Linfoma de Hodgkin estadio III. En tratamiento con quimioterapia combinada (esquema ABVD). Tolera bien el tratamiento con efectos secundarios controlables. Respuesta parcial favorable despu√©s de 4 ciclos."
}

$pat1Response = Invoke-ApiRequest -Method "POST" -Endpoint "/patients" -Body $patient1 -Token $token

if ($pat1Response) {
    Write-Host "‚úÖ Paciente creado: Sof√≠a Ram√≠rez" -ForegroundColor Green
    Write-Host "   ID: $($pat1Response.id)" -ForegroundColor Gray
    Write-Host "   Diagn√≥stico: $($pat1Response.diagnosis)" -ForegroundColor Gray
    Write-Host "   üì± QR Code: $API_URL/patients/$($pat1Response.id)/qr" -ForegroundColor Cyan
    $patient1Id = $pat1Response.id
}

Write-Host ""

$pat2Response = Invoke-ApiRequest -Method "POST" -Endpoint "/patients" -Body $patient2 -Token $token

if ($pat2Response) {
    Write-Host "‚úÖ Paciente creado: Pedro Flores" -ForegroundColor Green
    Write-Host "   ID: $($pat2Response.id)" -ForegroundColor Gray
    Write-Host "   Diagn√≥stico: $($pat2Response.diagnosis)" -ForegroundColor Gray
    Write-Host "   üì± QR Code: $API_URL/patients/$($pat2Response.id)/qr" -ForegroundColor Cyan
    $patient2Id = $pat2Response.id
}

Write-Host ""

# ============================================
# 5. REGISTRAR USUARIOS PACIENTES
# ============================================
Write-Host "üîë Registrando usuarios para los pacientes..." -ForegroundColor Yellow
Write-Host ""

$patientUser1 = @{
    name = "Sof√≠a Ram√≠rez"
    email = "sofia.ramirez@email.cl"
    password = "Patient123!"
    rut = "56.789.012-3"
    role = "patient"
}

$patientUser2 = @{
    name = "Pedro Flores"
    email = "pedro.flores@email.cl"
    password = "Patient123!"
    rut = "67.890.123-4"
    role = "patient"
}

$patUser1Response = Invoke-ApiRequest -Method "POST" -Endpoint "/auth/register" -Body $patientUser1
if ($patUser1Response) {
    Write-Host "‚úÖ Usuario paciente creado: sofia.ramirez@email.cl" -ForegroundColor Green
}

$patUser2Response = Invoke-ApiRequest -Method "POST" -Endpoint "/auth/register" -Body $patientUser2
if ($patUser2Response) {
    Write-Host "‚úÖ Usuario paciente creado: pedro.flores@email.cl" -ForegroundColor Green
}

Write-Host ""

# ============================================
# 6. CREAR NOTAS CL√çNICAS
# ============================================
if ($patient1Id -and $doctor1Id) {
    Write-Host "üìù Creando notas cl√≠nicas..." -ForegroundColor Yellow
    Write-Host ""
    
    $note1 = @{
        title = "Consulta de seguimiento post-cirug√≠a"
        content = "Paciente acude a control post-operatorio. Herida quir√∫rgica en buen estado, sin signos de infecci√≥n. Retiro de puntos programado para pr√≥xima semana. Paciente refiere dolor leve controlado con analg√©sicos. Se inicia protocolo de quimioterapia adyuvante."
        patientId = $patient1Id
        authorId = $doctor1Id
        authorName = "Dr. Carlos Mendoza"
    }
    
    $note1Response = Invoke-ApiRequest -Method "POST" -Endpoint "/patient-notes" -Body $note1 -Token $token
    
    if ($note1Response) {
        Write-Host "‚úÖ Nota cl√≠nica creada: $($note1.title)" -ForegroundColor Green
    }
}

if ($patient2Id -and $doctor1Id) {
    $note2 = @{
        title = "Evaluaci√≥n pre-quimioterapia"
        content = "Paciente en condiciones para inicio de quimioterapia. Hemograma dentro de par√°metros aceptables. Funci√≥n renal y hep√°tica normales. Se programa primer ciclo de ABVD para esta semana. Paciente orientado sobre cuidados y posibles efectos adversos."
        patientId = $patient2Id
        authorId = $doctor1Id
        authorName = "Dr. Carlos Mendoza"
    }
    
    $note2Response = Invoke-ApiRequest -Method "POST" -Endpoint "/patient-notes" -Body $note2 -Token $token
    
    if ($note2Response) {
        Write-Host "‚úÖ Nota cl√≠nica creada: $($note2.title)" -ForegroundColor Green
    }
}

Write-Host ""

# ============================================
# 7. CREAR DOCUMENTOS
# ============================================
if ($patient1Id -and $doctor1Id) {
    Write-Host "üìÑ Creando documentos m√©dicos..." -ForegroundColor Yellow
    Write-Host ""
    
    $doc1 = @{
        title = "Biopsia de mama - Resultado histopatol√≥gico"
        type = "examen"
        url = "https://example.com/documents/biopsia-pat001.pdf"
        patientId = $patient1Id
        uploaderId = $doctor1Id
        description = "Resultado de biopsia confirmando diagn√≥stico"
    }
    
    $doc1Response = Invoke-ApiRequest -Method "POST" -Endpoint "/patient-documents" -Body $doc1 -Token $token
    
    if ($doc1Response) {
        Write-Host "‚úÖ Documento creado: $($doc1.title)" -ForegroundColor Green
    }
}

if ($patient2Id -and $doctor1Id) {
    $doc2 = @{
        title = "TAC de t√≥rax - Evaluaci√≥n inicial"
        type = "examen"
        url = "https://example.com/documents/tac-pat002.pdf"
        patientId = $patient2Id
        uploaderId = $doctor1Id
        description = "TAC para evaluaci√≥n inicial del linfoma"
    }
    
    $doc2Response = Invoke-ApiRequest -Method "POST" -Endpoint "/patient-documents" -Body $doc2 -Token $token
    
    if ($doc2Response) {
        Write-Host "‚úÖ Documento creado: $($doc2.title)" -ForegroundColor Green
    }
}

Write-Host ""

# ============================================
# RESUMEN FINAL
# ============================================
Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Cyan
Write-Host "‚úÖ POBLACI√ìN DE BASE DE DATOS COMPLETADA" -ForegroundColor Green
Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Cyan
Write-Host ""
Write-Host "üìã CREDENCIALES DE ACCESO (PRODUCCI√ìN - AZURE SQL):" -ForegroundColor Yellow
Write-Host ""
Write-Host "üë®‚Äç‚öïÔ∏è  M√âDICOS:" -ForegroundColor Cyan
Write-Host "   üìß carlos.mendoza@hospital.cl" -ForegroundColor White
Write-Host "   üîë Doctor123!" -ForegroundColor White
Write-Host ""
Write-Host "   üìß maria.gonzalez@hospital.cl" -ForegroundColor White
Write-Host "   üîë Doctor123!" -ForegroundColor White
Write-Host ""
Write-Host "üë©‚Äç‚öïÔ∏è  ENFERMERAS:" -ForegroundColor Cyan
Write-Host "   üìß ana.perez@hospital.cl" -ForegroundColor White
Write-Host "   üîë Nurse123!" -ForegroundColor White
Write-Host ""
Write-Host "   üìß jose.silva@hospital.cl" -ForegroundColor White
Write-Host "   üîë Nurse123!" -ForegroundColor White
Write-Host ""
Write-Host "üë§ PACIENTES:" -ForegroundColor Cyan
Write-Host "   üìß sofia.ramirez@email.cl" -ForegroundColor White
Write-Host "   üîë Patient123!" -ForegroundColor White
Write-Host ""
Write-Host "   üìß pedro.flores@email.cl" -ForegroundColor White
Write-Host "   üîë Patient123!" -ForegroundColor White
Write-Host ""
Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Cyan
Write-Host ""
Write-Host "üéØ Siguiente paso:" -ForegroundColor Yellow
Write-Host "   Ejecuta: .\verify-database.ps1" -ForegroundColor White
Write-Host "   Para verificar que todo se guard√≥ correctamente" -ForegroundColor Gray
Write-Host ""
Write-Host "üöÄ Luego inicia el frontend:" -ForegroundColor Yellow
Write-Host "   cd ..\web" -ForegroundColor White
Write-Host "   npm run dev" -ForegroundColor White
Write-Host ""
